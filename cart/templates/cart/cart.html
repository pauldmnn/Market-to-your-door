{% extends "base.html" %}
{% load static %}
{% block content %}
    <div class="container my-5">
    <h2>Your Cart</h2>
    {% if cart_items %}
        <table class="table table-striped">
        <thead>
            <tr>
            <th>Product</th>
            <th>Image</th>
            <th>Unit Price</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart_items %}
            <tr id="cart-item-{{ item.product.slug }}">
                <td>{{ item.product.name }}</td>
                <td>
                {% if item.product.image %}
                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" style="width:80px;">
                {% endif %}
                </td>
                <td>£{{ item.product.price|floatformat:2 }} / {{ item.product.get_price_unit_display }}</td>
                <td>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn" data-slug="{{ item.product.slug }}" data-action="decrease">-</button>
                    <span class="mx-2" id="quantity-{{ item.product.slug }}">{{ item.quantity }}</span>
                    <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn" data-slug="{{ item.product.slug }}" data-action="increase">+</button>
                    <span class="ms-2">{{ item.product.get_price_unit_display }}</span>
                </div>
                </td>
                <td id="total-{{ item.product.slug }}">£{{ item.total_price|floatformat:2 }}</td>
                <td>
                <button type="button" class="btn btn-danger btn-sm remove-item" data-slug="{{ item.product.slug }}">Remove</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
            <td colspan="4" class="text-end"><strong>Grand Total:</strong></td>
            <td><strong id="grand-total">£{{ overall_total|floatformat:2 }}</strong></td>
            </tr>
        </tfoot>
        </table>


    {% else %}
        <p>Your cart is empty.</p>
    {% endif %}
    </div>

    <!-- JavaScript for Quantity Updates -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".quantity-btn").forEach(button => {
                button.addEventListener("click", function () {
                    const slug = this.dataset.slug;
                    const action = this.dataset.action;
                    updateCartQuantity(slug, action);
                });
            });
      
            document.querySelectorAll(".remove-item").forEach(button => {
                button.addEventListener("click", function () {
                    const slug = this.dataset.slug;
                    updateCartQuantity(slug, "remove");
                });
            });
      
            function updateCartQuantity(slug, action) {
                fetch("{% url 'update_cart' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ slug: slug, action: action }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(`quantity-${slug}`).innerText = data.new_quantity;
                        document.getElementById(`total-${slug}`).innerText = `£${data.total_price.toFixed(2)}`;
                        
                        if (!isNaN(data.grand_total)) {
                            document.getElementById("grand-total").innerText = `£${data.grand_total.toFixed(2)}`;
                        }
      
                        if (data.new_quantity <= 0) {
                            document.getElementById(`cart-item-${slug}`).remove();
                        }
                    } else {
                        alert(data.error);
                    }
                })
                .catch(error => console.error("Error updating cart:", error));
            }
        });
    </script>
      
{% endblock %}
